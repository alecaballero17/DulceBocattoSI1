{% extends "base.html" %}
{% block content %}
<h2>Editar detalle — Pedido #{{ pedido.id }}</h2>

<form id="form-editar" method="post">
  {% csrf_token %}

  <table class="table" id="tabla-detalle">
    <thead>
      <tr>
        <th style="width:28%">Producto</th>
        <th style="width:28%">Sabor</th>
        <th style="width:14%">Cantidad</th>
        <th style="width:14%">P. unitario</th>
        <th style="width:10%"></th>
      </tr>
    </thead>
    <tbody>
      {% for d in detalle %}
      <tr>
        <td>
          <select name="p_{{ forloop.counter0 }}" class="form-control" required>
            {% for pr in productos %}
              <option value="{{ pr.id }}" {% if pr.id == d.producto_id %}selected{% endif %}>{{ pr.nombre }}</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <select name="s_{{ forloop.counter0 }}" class="form-control" required>
            {% for sv in sabores %}
              <option value="{{ sv.id }}" {% if sv.id == d.sabor_id %}selected{% endif %}>{{ sv.nombre }}</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <input name="c_{{ forloop.counter0 }}" value="{{ d.cantidad }}" step="0.001" min="0.001" type="number" class="form-control" required>
        </td>
        <td>
          <input name="u_{{ forloop.counter0 }}" value="{{ d.precio_unitario }}" step="0.01" min="0" type="number" class="form-control" required>
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">Quitar</button>
        </td>
      </tr>
      {% empty %}
      {% endfor %}
    </tbody>
  </table>

  <input type="hidden" name="filas" id="filas">

  <button type="button" class="btn btn-outline-primary" id="btn-agregar">+ Agregar fila</button>
  <button type="submit" class="btn btn-success">Guardar cambios</button>
  <a href="{% url 'pedido_detalle' pedido.id %}" class="btn btn-secondary">Cancelar</a>
</form>

<!-- ✅ Pasar JSON de forma segura -->
{{ productos|json_script:"productos-data" }}
{{ sabores|json_script:"sabores-data" }}

<script>
  // Leer los catálogos desde los <script type="application/json">
  const productos = JSON.parse(document.getElementById('productos-data').textContent);
  const sabores   = JSON.parse(document.getElementById('sabores-data').textContent);

  const tbody = document.querySelector('#tabla-detalle tbody');

  function optlist(arr, val) {
    return arr.map(o =>
      `<option value="${o.id}" ${String(o.id) === String(val) ? 'selected' : ''}>${o.nombre}</option>`
    ).join('');
  }

  function agregarFila() {
    const idx = tbody.rows.length; // usa el número actual de filas visibles
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select name="p_${idx}" class="form-control" required>
          ${optlist(productos, '')}
        </select>
      </td>
      <td>
        <select name="s_${idx}" class="form-control" required>
          ${optlist(sabores, '')}
        </select>
      </td>
      <td><input name="c_${idx}" type="number" step="0.001" min="0.001" class="form-control" required></td>
      <td><input name="u_${idx}" type="number" step="0.01"  min="0" class="form-control" required></td>
      <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">Quitar</button></td>
    `;
    tbody.appendChild(tr);
  }

  // Asegura el conteo de filas incluso si se envía con Enter
  function contarFilas() {
    document.getElementById('filas').value = tbody.rows.length;
  }

  document.getElementById('btn-agregar').addEventListener('click', agregarFila);
  document.getElementById('form-editar').addEventListener('submit', contarFilas);
</script>
{% endblock %}
